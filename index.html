<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>RVC101 Photo Booth v12 ‚Äî Clean Full Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- QR Code library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root{
      --bg1:#0b0f1a; --bg2:#1a1a2e; --purple:#7b3fe4; --blue:#00d4ff;
      --pink:#ff0080; --gold:#ffd700; --green:#00ff88; --text:#e9f0ff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{ text-align:center; margin:10px 0 20px }
    h1{
      margin:0 0 8px; font-size:2rem; font-weight:800;
      background:linear-gradient(45deg,var(--blue),var(--purple),var(--pink));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .badge{
      display:inline-block; margin-left:8px; padding:4px 10px; border-radius:14px;
      background:linear-gradient(45deg,var(--gold),#ff9f3f); color:#1a1000; font-weight:800; font-size:.9rem;
    }
    .grid{display:grid; gap:20px; grid-template-columns: 1.2fr .8fr}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .panel{
      background:rgba(0,0,0,.55);
      border:1px solid rgba(123,63,228,.35);
      border-radius:16px; padding:16px;
      box-shadow:0 0 25px rgba(123,63,228,.18);
    }
    .camera{
      border-radius:16px; overflow:hidden; position:relative; background:#000;
    }
    video{ display:block; width:100%; height:auto; }
    .placeholder{
      aspect-ratio:16/9; display:flex; align-items:center; justify-content:center; flex-direction:column;
      color:#b7c4ff; background:linear-gradient(45deg,#111b2a,#121a2d);
    }
    .controls .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    .controls label{font-weight:700; color:var(--blue); display:block; margin-bottom:6px}
    input[type="text"], select, input[type="file"]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(123,63,228,.35);
      background:rgba(255,255,255,.05); color:var(--text);
    }
    .slider-wrap{margin:10px 0}
    .slider-label{display:flex; justify-content:space-between; font-size:.95rem; margin-bottom:4px}
    input[type="range"]{ width:100% }

    .frames{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
    .frame-btn{
      padding:10px; border:2px solid rgba(123,63,228,.35); border-radius:10px;
      background:rgba(255,255,255,.04); cursor:pointer; text-align:center; font-weight:700;
      transition:.2s border-color,.2s background;
    }
    .frame-btn.active, .frame-btn:hover{
      border-color:var(--blue); background:rgba(0,212,255,.12);
    }

    .btns{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:12px }
    .btn{
      border:0; padding:12px 18px; border-radius:12px; font-weight:800; cursor:pointer; color:#fff;
      background:linear-gradient(45deg,var(--purple),var(--blue));
    }
    .btn.alt{ background:linear-gradient(45deg,#3e3e3e,#7a7a7a) }
    .btn.warn{ background:linear-gradient(45deg,var(--gold),#ff9f3f); color:#111 }
    .btn.ok{ background:linear-gradient(45deg,var(--green),#00c070) }
    .center{text-align:center}

    .preview img{
      max-width:100%; border-radius:14px; box-shadow:0 0 35px rgba(123,63,228,.28);
    }
    .qr{ margin-top:12px; text-align:center }
    .qr-box{ display:inline-block; padding:10px; background:#fff; border-radius:10px }
    footer{ margin:20px 0 10px; text-align:center; font-size:.9rem; color:#cfe4ff }
    a{ color:var(--blue) }
    .countdown{
      position:absolute; inset:auto 0 12px 0; margin:auto; width:140px;
      background:rgba(0,0,0,.55); border:1px solid rgba(0,212,255,.35);
      text-align:center; padding:6px 10px; border-radius:12px; display:none; font-weight:800; color:var(--blue);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>RVC101 Photo Booth <span class="badge">v12 Clean</span></h1>
      <div>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö ‚Ä¢ ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á/‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå ‚Ä¢ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î/QR</div>
    </header>

    <div class="grid">
      <!-- LEFT: Camera & Preview -->
      <section class="panel">
        <div class="camera" id="cameraBox">
          <video id="video" autoplay playsinline muted style="display:none;"></video>
          <div id="placeholder" class="placeholder">
            <div>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <small>‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡∏ö‡∏ô HTTPS</small>
          </div>
          <div id="countdown" class="countdown"></div>
        </div>

        <div class="btns">
          <button class="btn ok" id="startCamera">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
          <button class="btn" id="switchCamera" disabled>üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
          <button class="btn alt" id="rotate90" disabled>‚Üª ‡∏´‡∏°‡∏∏‡∏ô 90¬∞</button>
          <button class="btn warn" id="capture" disabled>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
          <button class="btn alt" id="timerBtn" disabled>‚è∞ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
        </div>

        <div class="btns" id="timerRow" style="display:none;">
          <button class="btn alt" data-timer="3">3 ‡∏ß‡∏¥</button>
          <button class="btn alt" data-timer="5">5 ‡∏ß‡∏¥</button>
          <button class="btn alt" data-timer="10">10 ‡∏ß‡∏¥</button>
          <button class="btn" id="cancelTimer">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>

        <div class="panel preview" id="previewPanel" style="margin-top:14px; display:none;">
          <div class="center" style="margin-bottom:8px; font-weight:800;">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢</div>
          <img id="previewImg" alt="preview">
          <div class="btns">
            <button class="btn ok" id="downloadBtn">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PNG</button>
            <button class="btn" id="qrBtn">üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á QR</button>
          </div>

          <div class="qr" id="qrSection" style="display:none;">
            <div style="margin:8px 0; color:#a9c7ff;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û</div>
            <div class="qr-box">
              <canvas id="qrCanvas"></canvas>
            </div>
            <div style="margin-top:6px; font-size:.85rem; color:#cfe4ff;">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠/‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏†‡∏≤‡∏û‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Controls -->
      <aside class="panel controls">
        <div class="row">
          <div>
            <label for="nickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
            <input id="nickname" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ü‡∏Å‡∏±‡∏™">
          </div>
          <div>
            <label for="team">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</label>
            <input id="team" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Team Hero">
          </div>
        </div>

        <div class="row">
          <div>
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á <span id="bVal">100%</span></label>
            <input type="range" id="brightness" min="50" max="150" value="100">
          </div>
          <div>
            <label>‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå <span id="cVal">100%</span></label>
            <input type="range" id="contrast" min="50" max="150" value="100">
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
          <div class="frames" id="frames">
            <div class="frame-btn active" data-frame="main">RVC101 Main</div>
            <div class="frame-btn" data-frame="champ">Champion</div>
            <div class="frame-btn" data-frame="hero">Team Hero</div>
            <div class="frame-btn" data-frame="glitch">Glitch</div>
            <div class="frame-btn" data-frame="neon">Neon</div>
            <div class="frame-btn" data-frame="sponsor">Sponsor</div>
            <div class="frame-btn" data-frame="custom" id="customBtn" style="display:none;">Custom</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="customFrame">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏á (PNG/JPG)</label>
          <input id="customFrame" type="file" accept="image/*">
        </div>

        <div style="margin-top:10px;">
          <label for="size">‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</label>
          <select id="size">
            <option value="hd">HD (1280x720)</option>
            <option value="fullhd" selected>Full HD (1920x1080)</option>
            <option value="4k">4K (3840x2160)</option>
          </select>
        </div>
      </aside>
    </div>

    <footer>
      ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢: ‡∏Ñ‡∏£‡∏π‡∏™‡∏∏‡∏†‡∏≤‡∏î‡∏≤ ‡∏Ñ‡∏≥‡∏ï‡∏≤ | ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <a href="mailto:suphada@rvc.ac.th">suphada@rvc.ac.th</a> ‚Ä¢ ‡πÇ‡∏ó‡∏£ 097-1697157
    </footer>
  </div>

  <canvas id="work" style="display:none;"></canvas>

  <script>
    // ======= State =======
    let stream = null;
    let currentFacing = 'user';
    let rotation = 0;
    let currentFrame = 'main';
    let customFrameImg = null;
    let currentDataUrl = null;

    // ======= DOM =======
    const video = document.getElementById('video');
    const placeholder = document.getElementById('placeholder');
    const startBtn = document.getElementById('startCamera');
    const switchBtn = document.getElementById('switchCamera');
    const rotateBtn = document.getElementById('rotate90');
    const captureBtn = document.getElementById('capture');
    const timerBtn = document.getElementById('timerBtn');
    const timerRow = document.getElementById('timerRow');
    const cancelTimerBtn = document.getElementById('cancelTimer');
    const countdownEl = document.getElementById('countdown');

    const nickname = document.getElementById('nickname');
    const team = document.getElementById('team');

    const brightness = document.getElementById('brightness');
    const contrast = document.getElementById('contrast');
    const bVal = document.getElementById('bVal');
    const cVal = document.getElementById('cVal');

    const framesWrap = document.getElementById('frames');
    const customInput = document.getElementById('customFrame');
    const customBtn = document.getElementById('customBtn');
    const sizeSel = document.getElementById('size');

    const work = document.getElementById('work');
    const wctx = work.getContext('2d');

    const previewPanel = document.getElementById('previewPanel');
    const previewImg = document.getElementById('previewImg');
    const downloadBtn = document.getElementById('downloadBtn');
    const qrBtn = document.getElementById('qrBtn');
    const qrSection = document.getElementById('qrSection');
    const qrCanvas = document.getElementById('qrCanvas');

    // ======= Init UI =======
    brightness.addEventListener('input', () => {
      bVal.textContent = brightness.value + '%';
      applyFilters();
    });
    contrast.addEventListener('input', () => {
      cVal.textContent = contrast.value + '%';
      applyFilters();
    });

    framesWrap.querySelectorAll('.frame-btn').forEach(el => {
      el.addEventListener('click', () => {
        framesWrap.querySelectorAll('.frame-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        currentFrame = el.dataset.frame;
      });
    });

    customInput.addEventListener('change', e => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
          customFrameImg = img;
          customBtn.style.display = 'block';
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    startBtn.addEventListener('click', startCamera);
    switchBtn.addEventListener('click', async () => {
      currentFacing = (currentFacing === 'user') ? 'environment' : 'user';
      await startCamera(true);
    });
    rotateBtn.addEventListener('click', () => {
      rotation = (rotation + 90) % 360;
      applyFilters();
    });

    captureBtn.addEventListener('click', capture);
    timerBtn.addEventListener('click', () => {
      timerRow.style.display = 'flex';
    });
    timerRow.addEventListener('click', e => {
      const t = e.target.getAttribute('data-timer');
      if (t) startCountdown(parseInt(t,10));
    });
    cancelTimerBtn.addEventListener('click', cancelCountdown);

    downloadBtn.addEventListener('click', () => {
      if (!currentDataUrl) return;
      const a = document.createElement('a');
      a.href = currentDataUrl; a.download = `RVC101_${Date.now()}.png`; a.click();
    });

    qrBtn.addEventListener('click', async () => {
      if (!currentDataUrl) return;
      const htmlUrl = await buildDownloadHTMLDataURL(currentDataUrl);
      qrSection.style.display = 'block';
      await QRCode.toCanvas(qrCanvas, htmlUrl, { width: 220, errorCorrectionLevel:'L' });
    });

    // ======= Camera =======
    async function startCamera(isRestart=false){
      try{
        if (stream){ stream.getTracks().forEach(t => t.stop()); }
        const constraints = { video: { facingMode: currentFacing, width:{ideal:1280}, height:{ideal:720} } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        video.style.display = 'block';
        placeholder.style.display = 'none';
        [switchBtn, rotateBtn, captureBtn, timerBtn].forEach(b => b.disabled = false);
        applyFilters();
        if (!isRestart) currentDataUrl = null;
      }catch(err){
        console.error(err);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ HTTPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á');
      }
    }

    function applyFilters(){
      const f = `brightness(${brightness.value}%) contrast(${contrast.value}%) rotate(${rotation}deg)`;
      video.style.filter = f;
      video.style.transform = `rotate(${rotation}deg)`;
    }

    // ======= Capture =======
    function capture(){
      if (!validateNames()) return;

      const sel = sizeSel.value;
      let w=1920,h=1080;
      if (sel==='hd'){w=1280;h=720}
      if (sel==='4k'){w=3840;h=2160}

      work.width = w; work.height = h;
      wctx.save();

      // ‡∏´‡∏°‡∏∏‡∏ô‡∏†‡∏≤‡∏û‡πÉ‡∏ô canvas ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô
      if (rotation !== 0){
        wctx.translate(w/2, h/2);
        wctx.rotate(rotation * Math.PI / 180);
        wctx.translate(-w/2, -h/2);
      }

      // ‡∏à‡∏≥‡∏•‡∏≠‡∏á filter ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ brightness/contrast
      const b = brightness.value, c = contrast.value;
      wctx.filter = `brightness(${b}%) contrast(${c}%)`;
      wctx.drawImage(video, 0, 0, w, h);
      wctx.filter = 'none';

      // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö
      drawFrame(wctx, w, h);

      // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      drawTextOverlay(wctx, w, h);

      wctx.restore();

      currentDataUrl = work.toDataURL('image/png');
      previewImg.src = currentDataUrl;
      previewPanel.style.display = 'block';
      qrSection.style.display = 'none';
      window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
      flashWhite();
    }

    function drawFrame(ctx, w, h){
      const id = currentFrame;
      ctx.save();

      // ‡∏Å‡∏£‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
      ctx.strokeStyle = '#7b3fe4';
      ctx.lineWidth = 10;
      ctx.strokeRect(10,10,w-20,h-20);

      if (id==='champ'){
        const g=ctx.createLinearGradient(0,0,w,h);
        g.addColorStop(0,'#ffd700'); g.addColorStop(.5,'#b87333'); g.addColorStop(1,'#ffd700');
        ctx.strokeStyle=g; ctx.lineWidth=12; ctx.strokeRect(8,8,w-16,h-16);
      }
      if (id==='hero'){
        const rg=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.max(w,h)/2);
        rg.addColorStop(0,'rgba(0,212,255,.25)'); rg.addColorStop(1,'transparent');
        ctx.fillStyle=rg; ctx.fillRect(0,0,w,h);
      }
      if (id==='glitch'){
        ctx.strokeStyle='#ff0080'; ctx.lineWidth=10; ctx.strokeRect(10,10,w-20,h-20);
        ctx.strokeStyle='#00ff88'; ctx.lineWidth=2;
        for(let i=0;i<5;i++){ const y=Math.random()*h; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
      }
      if (id==='neon'){
        ctx.shadowColor='#00d4ff'; ctx.shadowBlur=18; ctx.strokeStyle='#00d4ff'; ctx.lineWidth=8;
        ctx.strokeRect(16,16,w-32,h-32); ctx.shadowBlur=0;
      }
      if (id==='sponsor'){
        ctx.strokeStyle='rgba(0,212,255,.6)'; ctx.lineWidth=12; ctx.strokeRect(10,10,w-20,h-20);
        ctx.fillStyle='rgba(255,255,255,.1)'; ctx.fillRect(w-220,h-120,200,90);
        ctx.strokeStyle='rgba(0,212,255,.45)'; ctx.lineWidth=2; ctx.strokeRect(w-220,h-120,200,90);
        ctx.fillStyle='rgba(255,255,255,.75)'; ctx.font='bold 18px Arial'; ctx.textAlign='center';
        ctx.fillText('SPONSOR LOGO', w-120, h-70);
      }
      if (id==='custom' && customFrameImg){
        ctx.drawImage(customFrameImg, 0, 0, w, h);
      }

      // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ü‡∏£‡∏°
      const titleMap={
        main:'RVC101 Esports Challenge 2025 ‚Äî v12',
        champ:'üëë Champion Mode',
        hero:'‚ö° Team Hero',
        glitch:'üî• Glitch Style',
        neon:'üíé Cyber Neon',
        sponsor:'Powered by Sponsors',
        custom:'Custom Frame'
      };
      ctx.fillStyle='#00d4ff'; ctx.font='bold 26px Arial'; ctx.textAlign='center';
      ctx.fillText(titleMap[id] || titleMap.main, w/2, 56);

      ctx.restore();
    }

    function drawTextOverlay(ctx, w, h){
      const n = nickname.value.trim();
      const t = team.value.trim();
      const now = new Date();
      const ts = now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH');

      // ‡πÅ‡∏ñ‡∏ö‡∏î‡∏≥‡∏•‡πà‡∏≤‡∏á
      ctx.fillStyle='rgba(0,0,0,.65)'; ctx.fillRect(0, h-130, w, 130);

      ctx.fillStyle='#00d4ff'; ctx.font='bold 32px Arial'; ctx.textAlign='left';
      ctx.fillText(`üéÆ ${n}`, 26, h-86);

      ctx.fillStyle='#7b3fe4'; ctx.font='bold 28px Arial';
      ctx.fillText(`üèÜ ${t}`, 26, h-46);

      ctx.textAlign='right';
      ctx.fillStyle='#ffd700'; ctx.font='bold 20px Arial';
      ctx.fillText('v12 Clean', w-26, h-86);

      ctx.fillStyle='#ffffff'; ctx.font='18px Arial';
      ctx.fillText(ts, w-26, h-46);
    }

    function validateNames(){
      if (!nickname.value.trim() || !team.value.trim()){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û');
        return false;
      }
      return true;
    }

    // ======= Countdown =======
    let countdownTimer = null;
    function startCountdown(sec){
      if (!validateNames()) return;
      timerRow.style.display = 'none';
      countdownEl.style.display = 'block';
      countdownEl.textContent = sec;
      disableTopButtons(true);

      countdownTimer = setInterval(()=>{
        sec--;
        if (sec>0){ countdownEl.textContent = sec; }
        else{
          countdownEl.textContent = 'üì∏';
          setTimeout(()=>{
            capture();
            cancelCountdown();
          }, 450);
        }
      },1000);
    }
    function cancelCountdown(){
      if (countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
      countdownEl.style.display = 'none';
      disableTopButtons(false);
    }
    function disableTopButtons(disabled){
      [startBtn,switchBtn,rotateBtn,captureBtn,timerBtn].forEach(b => {
        if (b.id==='startCamera') return; // ‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        b.disabled = disabled;
      });
    }

    // ======= QR helper =======
    async function buildDownloadHTMLDataURL(imageDataUrl){
      // ‡∏¢‡πà‡∏≠/‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô JPEG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ QR ‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô
      const optimized = await resizeCompress(imageDataUrl, 1280, 0.7);
      const page = `<html><meta charset="utf-8"><title>RVC101 Photo</title>
<body style="margin:0;font-family:Arial;text-align:center;background:#111;color:#eee">
<h2>üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û...</h2>
<img src="${optimized}" style="max-width:95%;margin:10px auto;display:block;border:1px solid #444">
<script>
var a=document.createElement('a');a.href='${optimized}';a.download='RVC101_${Date.now()}.jpg';
document.body.appendChild(a);a.click();
<\/script>
</body></html>`;
      return 'data:text/html;charset=utf-8,' + encodeURIComponent(page);
    }

    function resizeCompress(src, maxW=1280, q=0.7){
      return new Promise((resolve,reject)=>{
        const img=new Image();
        img.onload=()=>{
          const ratio = img.width>maxW ? maxW/img.width : 1;
          const w = Math.round(img.width*ratio);
          const h = Math.round(img.height*ratio);
          const c=document.createElement('canvas'); c.width=w; c.height=h;
          c.getContext('2d').drawImage(img,0,0,w,h);
          resolve(c.toDataURL('image/jpeg', q));
        };
        img.onerror=reject;
        img.src=src;
      });
    }

    // ======= Small UX =======
    function flashWhite(){
      const d=document.createElement('div');
      d.style.cssText='position:fixed;inset:0;background:#fff;opacity:.85;z-index:9999;pointer-events:none';
      document.body.appendChild(d);
      setTimeout(()=>{ d.style.transition='opacity .25s'; d.style.opacity='0'; setTimeout(()=>d.remove(),260); },120);
    }
  </script>
</body>
</html>
