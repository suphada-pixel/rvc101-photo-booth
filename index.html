<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RVC Smart Career Photo Booth</title>
    <!-- โหลด Tailwind CSS CDN สำหรับการออกแบบที่สวยงามและ Responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- โหลด Font Kanit สำหรับภาษาไทยที่อ่านง่าย -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* กำหนดค่าเริ่มต้นของ Tailwind */
        :root {
            --color-primary: #7b3fe4; /* ม่วง */
            --color-secondary: #56c2e6; /* ฟ้าอ่อน */
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f2f5, #e0e5ec); /* Gradient พื้นหลังนุ่มนวล */
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Gradient Button Style */
        .btn-primary {
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(123, 63, 228, 0.4);
            border: none;
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(123, 63, 228, 0.6);
            transform: translateY(-2px);
        }

        /* Responsive Video/Canvas Container */
        .camera-container {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1 / 1; /* กำหนดอัตราส่วน 1:1 */
            position: relative;
            background-color: #333;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        video, canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* กลับด้านภาพกล้องให้เหมือนกระจก */
        }

        #frame-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ไม่ให้ขวางการคลิก */
        }

        /* Progress Animation for Capture */
        @keyframes progress-animation {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .progress-bar {
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f00, #ff0);
            animation: progress-animation 1s forwards;
        }

        /* QR Code Canvas Styling */
        #qrcode-canvas {
            border: 4px solid var(--color-primary);
            border-radius: 1rem;
            margin-top: 1rem;
        }
    </style>

    <script>
        // --- ส่วนที่ 1: QR Code Generator (Embedded qrcode.js minimal version) ---
        // ฟังก์ชันสร้าง QR Code อย่างง่าย โดยไม่ต้องโหลดไฟล์ภายนอก
        function generateQRCode(text, canvasId, size = 128) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error("QR Code Canvas not found.");
                    return;
                }
                const qr = new QRCode(canvas, {
                    text: text,
                    width: size,
                    height: size,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                qr.makeCode(text);
            } catch (error) {
                console.error("Failed to generate QR code:", error);
            }
        }
        
        // **QRCode Library Source Code (Minimal Implementation)** - เพื่อให้รันได้ในไฟล์เดียว
        // เนื่องจากการฝังโค้ด qrcode.js ทั้งหมดทำให้โค้ดยาวเกินไปและมีความซ้ำซ้อน ผมจะใช้ฟังก์ชันที่เลียนแบบการทำงานหลักๆ ของ qrcode.js แทนเพื่อความเรียบง่าย แต่ถ้าเป็นสภาพแวดล้อมจริงควรใช้ Library ตัวเต็ม
        
        // (***Note: For actual production, a full, minified qrcode.js library must be included here. Due to length constraints, a placeholder structure is used, assuming the full library's implementation would be here.)
        // ผมจะใช้ฟังก์ชันที่กำหนดเองเพื่อให้โค้ดนี้รันได้ แต่ต้องยอมรับว่าอาจไม่ได้มีฟีเจอร์เท่า qrcode.js ตัวเต็ม
        
        // Placeholder for qrcode.js/Native QR function
        class QRCode {
            constructor(el, options) {
                this.el = el;
                this.options = options;
                this.el.width = options.width;
                this.el.height = options.height;
                this.ctx = this.el.getContext('2d');
            }
            makeCode(text) {
                const errorCorrectionLevel = this.options.correctLevel || 'M';
                const size = this.options.width;
                const ctx = this.ctx;
                
                // *** In a real scenario, the QR encoding logic would be here.
                // For this demonstration, we'll draw a colored square to simulate the loading effect.
                ctx.fillStyle = this.options.colorLight || "#ffffff";
                ctx.fillRect(0, 0, size, size);
                ctx.fillStyle = this.options.colorDark || "#000000";
                
                // Placeholder drawing: a checkerboard pattern
                const moduleCount = 16; 
                const moduleSize = size / moduleCount;
                for(let row = 0; row < moduleCount; row++) {
                    for(let col = 0; col < moduleCount; col++) {
                        if ((row + col) % 2 === 0) {
                            ctx.fillRect(col * moduleSize, row * moduleSize, moduleSize, moduleSize);
                        }
                    }
                }
                
                // Add text overlay for clarity (not standard QR)
                ctx.fillStyle = "#FF0000";
                ctx.font = "10px Kanit";
                ctx.textAlign = "center";
                ctx.fillText("SCAN ME (QR Mock)", size / 2, size / 2);
            }
        }
        
        // --- ส่วนที่ 2: Base64 Frame Data และ Logic หลัก ---
        
        // Base64 Placeholder PNGs สำหรับกรอบธีมเริ่มต้น (ไฟล์โปร่งใส PNG ที่มีเส้นขอบสี)
        // (นี่คือ Base64 PNG โปร่งใสขนาดเล็กที่มีข้อความระบุอยู่ เพื่อใช้ในการทดสอบ)
        const DEFAULT_FRAMES = [
            {
                name: "RVC101 Esports Challenge 2025",
                dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' /* Transparent */
            },
            {
                name: "RVC Smart Career (Tech)",
                dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' /* Transparent */
            }
        ];

        let video;
        let canvas;
        let resultCanvas;
        let frameSelect;
        let currentFrameUrl = DEFAULT_FRAMES[0].dataUrl;
        let allFrames = [...DEFAULT_FRAMES];

        // โหลดกรอบที่ผู้ใช้อัพโหลดไว้จาก LocalStorage (ถ้ามี)
        function loadCustomFrames() {
            const storedFrames = localStorage.getItem('rvc_custom_frames');
            if (storedFrames) {
                allFrames = [...DEFAULT_FRAMES, ...JSON.parse(storedFrames)];
            }
        }
        
        // บันทึกกรอบที่ผู้ใช้อัพโหลดลง LocalStorage
        function saveCustomFrames() {
            const customFrames = allFrames.filter((f, index) => index >= DEFAULT_FRAMES.length);
            localStorage.setItem('rvc_custom_frames', JSON.stringify(customFrames));
        }

        // อัพเดท Dropdown เมนู
        function updateFrameDropdown() {
            frameSelect.innerHTML = '';
            allFrames.forEach((frame, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = frame.name;
                frameSelect.appendChild(option);
            });
            currentFrameUrl = allFrames[frameSelect.value].dataUrl;
        }

        // จัดการการอัปโหลดกรอบ PNG
        function handleFrameUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            Array.from(files).forEach(file => {
                if (file.type !== 'image/png') {
                    alert('กรุณาอัปโหลดเฉพาะไฟล์ PNG เท่านั้น');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    // กำหนดชื่อกรอบอัตโนมัติ
                    const newFrame = {
                        name: `[Custom] ${file.name.replace('.png', '').substring(0, 20)}`,
                        dataUrl: e.target.result
                    };
                    allFrames.push(newFrame);
                    saveCustomFrames();
                    updateFrameDropdown();
                    // ตั้งค่าให้กรอบที่เพิ่งอัปโหลดถูกเลือกทันที
                    frameSelect.value = allFrames.length - 1;
                    currentFrameUrl = newFrame.dataUrl;
                };
                reader.readAsDataURL(file);
            });
            event.target.value = null; // Reset file input
            renderFrameOverlay();
            updateFrameListUI();
        }

        // ลบกรอบที่อัปโหลด (ห้ามลบกรอบเริ่มต้น)
        function deleteFrame(index) {
            if (index < DEFAULT_FRAMES.length) {
                console.warn('ไม่สามารถลบกรอบเริ่มต้นได้');
                return;
            }
            allFrames.splice(index, 1);
            saveCustomFrames();
            updateFrameDropdown();
            updateFrameListUI();
            
            // เลือกกรอบเริ่มต้นอันแรกเป็นค่า default
            frameSelect.value = 0;
            currentFrameUrl = allFrames[0].dataUrl;
            renderFrameOverlay();
        }

        // แสดงรายการกรอบที่อัปโหลดบน UI
        function updateFrameListUI() {
            const listContainer = document.getElementById('custom-frame-list');
            listContainer.innerHTML = '';
            allFrames.forEach((frame, index) => {
                const isCustom = index >= DEFAULT_FRAMES.length;
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 rounded-lg mb-1 ${isCustom ? 'bg-gray-100' : 'bg-gray-50'}`;
                
                const frameName = document.createElement('span');
                frameName.textContent = frame.name;
                frameName.className = 'text-sm truncate mr-2';
                
                item.appendChild(frameName);

                if (isCustom) {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'ลบ';
                    deleteButton.className = 'text-xs text-red-500 hover:text-red-700 font-bold';
                    deleteButton.onclick = () => deleteFrame(index);
                    item.appendChild(deleteButton);
                } else {
                     const defaultTag = document.createElement('span');
                     defaultTag.textContent = '(เริ่มต้น)';
                     defaultTag.className = 'text-xs text-indigo-500 font-medium ml-2';
                     item.appendChild(defaultTag);
                }
                listContainer.appendChild(item);
            });
        }

        // แสดงภาพกรอบ PNG บน Video Element เพื่อเป็น Preview
        function renderFrameOverlay() {
            const overlay = document.getElementById('frame-overlay');
            if (overlay) {
                overlay.src = currentFrameUrl;
            }
        }

        // เปิดกล้อง
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user' // ใช้กล้องหน้า
                    },
                    audio: false
                });
                video.srcObject = stream;
                document.getElementById('start-camera-btn').classList.add('hidden');
                document.getElementById('video-controls').classList.remove('hidden');
                document.getElementById('video-display').classList.remove('hidden');
            } catch (err) {
                console.error("เกิดข้อผิดพลาดในการเปิดกล้อง: ", err);
                document.getElementById('error-message').textContent = '⚠️ ไม่สามารถเข้าถึงกล้องได้ โปรดตรวจสอบสิทธิ์การเข้าถึง';
            }
        }
        
        // หยุดกล้อง
        function stopCamera() {
             if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        // จับภาพและซ้อนกรอบ
        function capturePhoto() {
            // แสดง Progress Bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.classList.remove('hidden');

            setTimeout(() => {
                // ซ่อน Video และ Controls, แสดง Canvas
                document.getElementById('video-controls').classList.add('hidden');
                document.getElementById('video-display').classList.add('hidden');
                document.getElementById('result-area').classList.remove('hidden');
                progressBar.classList.add('hidden');

                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;
                
                // ตั้งค่า Canvas ให้มีขนาดเท่ากับ Video ที่จับได้
                resultCanvas.width = videoWidth;
                resultCanvas.height = videoHeight;
                const ctx = resultCanvas.getContext('2d');
                
                // 1. วาดภาพจากกล้อง (กลับด้าน)
                ctx.save();
                ctx.scale(-1, 1); // กลับด้านแนวนอน
                ctx.drawImage(video, -videoWidth, 0, videoWidth, videoHeight);
                ctx.restore();
                
                // 2. วาดกรอบ PNG ซ้อนทับ
                const frameImg = new Image();
                frameImg.onload = () => {
                    ctx.drawImage(frameImg, 0, 0, videoWidth, videoHeight);
                    
                    // 3. วาดข้อความชื่อระบบและชื่อผู้ใช้ (จำลอง)
                    const frameName = allFrames[frameSelect.value].name;
                    const userName = document.getElementById('username-input').value || 'ผู้เข้าร่วมกิจกรรม';
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
                    ctx.shadowBlur = 10;
                    ctx.textAlign = 'center';
                    
                    // ชื่อระบบ RVC101 Esports Challenge 2025 (แสดงด้านบน)
                    ctx.font = `bold ${videoHeight / 25}px Kanit, sans-serif`;
                    ctx.fillText(frameName, videoWidth / 2, videoHeight * 0.1);
                    
                    // ชื่อผู้ใช้ (แสดงด้านล่าง)
                    ctx.font = `bold ${videoHeight / 30}px Kanit, sans-serif`;
                    ctx.fillText(userName, videoWidth / 2, videoHeight * 0.95);

                    // สร้าง QR Code จากภาพที่รวมแล้ว
                    const dataUrl = resultCanvas.toDataURL('image/png');
                    generateQRCode(dataUrl, 'qrcode-canvas', 180);

                    // แสดงข้อความสำเร็จ
                    document.getElementById('success-message').classList.remove('hidden');
                    stopCamera(); // หยุดการทำงานของกล้อง
                };
                frameImg.src = currentFrameUrl;

            }, 1000); // 1 วินาทีสำหรับ Progress Animation
        }
        
        // ดาวน์โหลดภาพ
        function downloadPhoto() {
            const image = resultCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'RVC_PhotoBooth_' + new Date().getTime() + '.png';
            link.href = image;
            link.click();
        }

        // เริ่มถ่ายใหม่
        function retakePhoto() {
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('success-message').classList.add('hidden');
            document.getElementById('video-controls').classList.remove('hidden');
            document.getElementById('video-display').classList.remove('hidden');
            startCamera(); // เปิดกล้องใหม่
        }

        // การตั้งค่าเริ่มต้นเมื่อโหลดหน้าเว็บ
        window.onload = () => {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            resultCanvas = document.getElementById('result-canvas');
            frameSelect = document.getElementById('frame-select');
            
            // โหลดและอัพเดทกรอบ
            loadCustomFrames();
            updateFrameDropdown();
            updateFrameListUI();

            // Event Listeners
            document.getElementById('start-camera-btn').addEventListener('click', startCamera);
            document.getElementById('capture-btn').addEventListener('click', capturePhoto);
            document.getElementById('download-btn').addEventListener('click', downloadPhoto);
            document.getElementById('retake-btn').addEventListener('click', retakePhoto);
            document.getElementById('frame-upload').addEventListener('change', handleFrameUpload);
            
            frameSelect.addEventListener('change', (e) => {
                currentFrameUrl = allFrames[e.target.value].dataUrl;
                renderFrameOverlay();
            });
            
            // แสดงกรอบเริ่มต้น
            renderFrameOverlay();
        };

        // เพื่อให้แน่ใจว่าฟังก์ชัน renderFrameOverlay ถูกเรียกเมื่อมีการเปลี่ยนหน้าต่าง/ขนาด (Responsive frame)
        window.onresize = renderFrameOverlay;

    </script>
</head>

<body>
    <div class="container mx-auto p-4 max-w-4xl min-h-screen flex flex-col">
        <!-- HEADER / ชื่อระบบ -->
        <header class="text-center mb-8 p-4 bg-white rounded-xl shadow-lg relative">
            <h1 class="text-3xl font-extrabold text-gray-800">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-400">RVC Smart Career Photo Booth</span>
            </h1>
            <p class="text-lg text-gray-600 mt-1">
                ระบบถ่ายภาพแนะแนวอาชีพอัจฉริยะ วิทยาลัยอาชีวศึกษาร้อยเอ็ด
            </p>
            <p class="text-sm font-light text-gray-500 mt-2 italic">
                "ถ่ายรูปตามธีมสาขาอาชีพ สแกน QR โหลดภาพได้ทันที!"
            </p>
            <!-- โลโก้วิทยาลัย (Placeholder) -->
            <div class="absolute top-4 right-4">
                <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-xs font-bold text-gray-700">
                    RVC
                </div>
            </div>
        </header>

        <main class="flex-grow w-full">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ส่วนการถ่ายภาพ / Video Display -->
                <div class="lg:order-1 order-2">
                    <div id="video-display" class="camera-container mb-4 hidden">
                        <video id="video" autoplay playsinline></video>
                        <img id="frame-overlay" alt="Frame Overlay">
                    </div>
                    
                    <button id="start-camera-btn" class="w-full btn-primary text-white font-bold py-3 rounded-xl text-lg hover:bg-opacity-90 transition duration-300 shadow-xl">
                        กดเพื่อเปิดกล้อง (Start Camera)
                    </button>
                    
                    <p id="error-message" class="text-red-500 text-center mt-2 font-medium"></p>
                    
                    <div id="video-controls" class="hidden">
                        <input type="text" id="username-input" placeholder="พิมพ์ชื่อ/ข้อความใต้ภาพที่นี่" maxlength="30" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 mb-4 text-center text-sm">
                        <button id="capture-btn" class="w-full btn-primary text-white font-bold py-3 rounded-xl text-lg shadow-xl">
                            📸 ถ่ายภาพ
                        </button>
                    </div>

                    <div id="progress-bar" class="progress-bar mt-4 hidden">
                        <div class="progress-fill"></div>
                    </div>
                    
                    <!-- ส่วนแสดงผลลัพธ์ -->
                    <div id="result-area" class="text-center hidden lg:order-2 order-1 mt-6">
                        <p id="success-message" class="text-xl font-bold text-green-600 mb-4 hidden">
                            เยี่ยมเลย! ถ่ายภาพสำเร็จ 🎉
                        </p>
                        <div class="camera-container mx-auto">
                            <canvas id="result-canvas"></canvas>
                        </div>
                        
                        <h3 class="text-lg font-bold mt-4 mb-2 text-gray-700">สแกนเพื่อดาวน์โหลดภาพ</h3>
                        <canvas id="qrcode-canvas" class="mx-auto w-[180px] h-[180px]"></canvas>
                        
                        <div class="flex justify-center space-x-4 mt-6">
                            <button id="download-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300">
                                ⬇️ ดาวน์โหลดภาพ
                            </button>
                            <button id="retake-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300">
                                🔄 ถ่ายใหม่
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ส่วนควบคุม / Frame Selection -->
                <div class="lg:order-2 order-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">🖼️ ตัวเลือกกรอบภาพ (Frame Options)</h2>
                    
                    <label for="frame-select" class="block text-sm font-medium text-gray-700 mb-2">1. เลือกกรอบธีม:</label>
                    <select id="frame-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white mb-4 focus:ring-purple-500 focus:border-purple-500 text-base">
                        <!-- Options will be populated by JS -->
                    </select>
                    
                    <h3 class="text-lg font-bold mb-3 text-gray-800 border-t pt-4">➕ อัปโหลดกรอบ PNG ของคุณเอง</h3>
                    <label for="frame-upload" class="block w-full text-center cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 rounded-lg transition duration-300 border-2 border-dashed border-gray-300">
                        เลือกไฟล์ PNG (อัปโหลดหลายไฟล์ได้)
                        <input type="file" id="frame-upload" accept="image/png" multiple class="hidden">
                    </label>

                    <h4 class="text-md font-bold mt-4 mb-2 text-gray-700 border-t pt-4">รายการกรอบที่มีในระบบ:</h4>
                    <div id="custom-frame-list" class="max-h-60 overflow-y-auto pr-2">
                        <!-- List populated by JS -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- FOOTER / ส่วนท้ายหน้า -->
        <footer class="w-full text-center mt-12 py-4 border-t border-gray-300 text-gray-600 text-sm">
            <p>
                พัฒนาโดย <span class="font-bold text-purple-600">นางสาวสุภาดา คำตา</span> (แผนกเทคโนโลยีสารสนเทศ) <br class="lg:hidden">
                <span class="font-bold">วิทยาลัยอาชีวศึกษาร้อยเอ็ด</span>
            </p>
            <div class="flex justify-center items-center mt-2 space-x-4">
                <!-- RVC Logo Placeholder -->
                <div class="w-8 h-8 bg-gray-400 rounded-full text-xs flex items-center justify-center">RVC</div>
                <!-- QR Website Placeholder (Mock) -->
                <div class="text-xs">QR เว็บไซต์หลัก RVC (Mock)</div>
                <div class="w-8 h-8 bg-black flex items-center justify-center">
                    <span class="text-white text-xs">QR</span>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>
