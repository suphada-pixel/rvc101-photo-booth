<!doctype html>
<html lang="th">
<head>
  <meta
charset="utf-8">
  <title>RVC101
Photo Booth v12 — Clean Full Page</title>
  <meta
name="viewport" content="width=device-width, initial-scale=1"
/>
    <script
src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root{
     --bg1:#0b0f1a;
--bg2:#1a1a2e; --purple:#7b3fe4;
--blue:#00d4ff;
     --pink:#ff0080; --gold:#ffd700;
--green:#00ff88; --text:#e9f0ff;
    }
    *{box-sizing:border-box}
html,body{height:100%}
    body{
      margin:0;
font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
     color:var(--text);
     background:linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    .container{max-width:1100px;margin:0
auto;padding:20px}
    header{
text-align:center; margin:10px 0 20px }
    h1{
      margin:0 0
8px; font-size:2rem; font-weight:800;
     background:linear-gradient(45deg,var(--blue),var(--purple),var(--pink));
      -webkit-background-clip:text;
background-clip:text; -webkit-text-fill-color:transparent;
    }
    .badge{
     display:inline-block; margin-left:8px; padding:4px10px; border-radius:14px;
     background:linear-gradient(45deg,var(--gold),#ff9f3f);
color:#1a1000; font-weight:800;
font-size:.9rem;
    }
    .grid{display:grid;
gap:20px; grid-template-columns: 1.2fr
.8fr}
    @media (max-width:920px){ .grid{grid-template-columns:1fr}
}
 
    .panel{
      background:rgba(0,0,0,.55);
      border:1px
solid rgba(123,63,228,.35);
      border-radius:16px;
padding:16px;
      box-shadow:0 0
25px rgba(123,63,228,.18);
    }
    .camera{
      border-radius:16px;
overflow:hidden; position:relative; background:#000;
    }
    video{
display:block; width:100%; height:auto; }
    .placeholder{
      aspect-ratio:16/9;
display:flex; align-items:center; justify-content:center;
flex-direction:column;
      color:#b7c4ff;
background:linear-gradient(45deg,#111b2a,#121a2d);
    }
    .controls
.row{ display:grid; gap:10px; grid-template-columns:1fr1fr }
    .controls
label{font-weight:700; color:var(--blue); display:block;
margin-bottom:6px}
   input[type="text"], select, input[type="file"]{
      width:100%;
padding:10px 12px; border-radius:10px;
border:1px solid rgba(123,63,228,.35);
      background:rgba(255,255,255,.05);
color:var(--text);
    }
    .slider-wrap{margin:10px0}
    .slider-label{display:flex;
justify-content:space-between; font-size:.95rem; margin-bottom:4px}
   input[type="range"]{ width:100% }
 
    .frames{
display:grid; grid-template-columns:repeat(2,1fr); gap:10px
}
    .frame-btn{
      padding:10px;
border:2px solid rgba(123,63,228,.35);
border-radius:10px;
      background:rgba(255,255,255,.04);
cursor:pointer; text-align:center; font-weight:700;
      transition:.2s
border-color,.2s background;
    }
    .frame-btn.active,
.frame-btn:hover{
     border-color:var(--blue); background:rgba(0,212,255,.12);
    }
 
    .btns{
display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
margin-top:12px }
    .btn{
      border:0;
padding:12px 18px; border-radius:12px;
font-weight:800; cursor:pointer; color:#fff;
     background:linear-gradient(45deg,var(--purple),var(--blue));
    }
    .btn.alt{
background:linear-gradient(45deg,#3e3e3e,#7a7a7a)
}
    .btn.warn{
background:linear-gradient(45deg,var(--gold),#ff9f3f);
color:#111 }
    .btn.ok{
background:linear-gradient(45deg,var(--green),#00c070)}
    .center{text-align:center}
 
    .preview
img{
      max-width:100%;
border-radius:14px; box-shadow:0 0
35px rgba(123,63,228,.28);
    }
    .qr{
margin-top:12px; text-align:center }
    .qr-box{
display:inline-block; padding:10px; background:#fff; border-radius:10px
}
    footer{ margin:20px0 10px; text-align:center; font-size:.9rem;
color:#cfe4ff }
    a{
color:var(--blue) }
    .countdown{
     position:absolute; inset:auto 0 12px 0;
margin:auto; width:140px;
      background:rgba(0,0,0,.55);
border:1px solid rgba(0,212,255,.35);
     text-align:center; padding:6px 10px;
border-radius:12px; display:none; font-weight:800;
color:var(--blue);
    }
  </style>
</head>
<body>
  <div
class="container">
    <header>
      <h1>RVC101
Photo Booth <span class="badge">v12
Clean</span></h1>
      <div>📸ถ่ายภาพ • เลือกกรอบ • ปรับแสง/คอนทราสต์ • ดาวน์โหลด/QR</div>
    </header>
 
    <div
class="grid">
            <section
class="panel">
        <div
class="camera" id="cameraBox">
          <video
id="video" autoplay playsinline muted
style="display:none;"></video>
          <div
id="placeholder" class="placeholder">
           <div>กดปุ่ม “เปิดกล้อง” เพื่อเริ่มใช้งาน</div>
           <small>ต้องอนุญาตสิทธิ์การใช้กล้อง และรันบน HTTPS</small>
          </div>
          <div
id="countdown" class="countdown"></div>
        </div>
 
        <div
class="btns">
          <button
class="btn ok" id="startCamera">📷เปิดกล้อง</button>
          <button
class="btn" id="switchCamera" disabled>🔄สลับกล้อง</button>
          <button
class="btn alt" id="rotate90" disabled>↻หมุน 90°</button>
          <button
class="btn warn" id="capture" disabled>📸ถ่ายภาพ</button>
          <button
class="btn alt" id="timerBtn" disabled>⏰ตั้งเวลา</button>
        </div>
 
        <div
class="btns" id="timerRow"
style="display:none;">
          <button
class="btn alt" data-timer="3">3
วิ</button>
          <button
class="btn alt" data-timer="5">5
วิ</button>
          <button
class="btn alt" data-timer="10">10
วิ</button>
          <button
class="btn" id="cancelTimer">❌ ยกเลิก</button>
        </div>
 
        <div
class="panel preview" id="previewPanel"
style="margin-top:14px; display:none;">
          <div
class="center" style="margin-bottom:8px;
font-weight:800;">ภาพที่ถ่าย</div>
          <img
id="previewImg" alt="preview">
          <div
class="btns">
            <button
class="btn ok" id="downloadBtn">💾ดาวน์โหลด PNG</button>
            <button
class="btn" id="qrBtn">📱 สร้างQR</button>
          </div>
 
          <div
class="qr" id="qrSection"
style="display:none;">
            <div
style="margin:8px 0; color:#a9c7ff;">สแกนเพื่อดาวน์โหลดภาพ</div>
            <div
class="qr-box">
             <canvas id="qrCanvas"></canvas>
           </div>
            <div
style="margin-top:6px; font-size:.85rem;
color:#cfe4ff;">ระบบย่อ/บีบอัดภาพอัตโนมัติสำหรับQR</div>
          </div>
        </div>
      </section>
 
            <aside
class="panel controls">
        <div
class="row">
          <div>
            <label
for="nickname">ชื่อเล่น</label>
            <input
id="nickname" type="text" placeholder="เช่น
โฟกัส">
          </div>
          <div>
            <label
for="team">ชื่อทีม</label>
            <input
id="team" type="text" placeholder="เช่นTeam Hero">
          </div>
        </div>
 
        <div
class="row">
          <div>
           <label>ความสว่าง <span
id="bVal">100%</span></label>
            <input
type="range" id="brightness" min="50"max="150" value="100">
          </div>
          <div>
           <label>คอนทราสต์ <span
id="cVal">100%</span></label>
            <input
type="range" id="contrast" min="50"max="150" value="100">
          </div>
        </div>
 
        <div
style="margin-top:10px;">
         <label>เลือกกรอบกิจกรรม</label>
          <div
class="frames" id="frames">
            <div
class="frame-btn active" data-frame="main">RVC101
Main</div>
            <div
class="frame-btn"
data-frame="champ">Champion</div>
            <div
class="frame-btn" data-frame="hero">Team
Hero</div>
            <div
class="frame-btn" data-frame="glitch">Glitch</div>
            <div
class="frame-btn" data-frame="neon">Neon</div>
            <div
class="frame-btn"
data-frame="sponsor">Sponsor</div>
            <div
class="frame-btn" data-frame="custom"
id="customBtn" style="display:none;">Custom</div>
          </div>
        </div>
 
        <div
style="margin-top:10px;">
          <label
for="customFrame">อัปโหลดกรอบเอง (PNG/JPG) **เลือกได้หลายไฟล์**</label>
          <input
id="customFrame" type="file" accept="image/*" **multiple**>
        </div>

                  <div
class="frames" id="customFramesContainer" style="margin-top:10px;">
                  </div>
 
        <div
style="margin-top:10px;">
          <label
for="size">ขนาดภาพส่งออก</label>
          <select
id="size">
            <option
value="hd">HD (1280x720)</option>
            <option
value="fullhd" selected>Full HD (1920x1080)</option>
            <option
value="4k">4K
(3840x2160)</option>
         </select>
        </div>
      </aside>
    </div>
 
    <footer>
     จัดทำโดย: ครูสุภาดา คำตา | ติดต่อ: <a
href="mailto:suphada@rvc.ac.th">suphada@rvc.ac.th</a> • โทร
097-1697157
    </footer>
  </div>
 
  <canvas
id="work" style="display:none;"></canvas>
 
  <script>
    //
======= State =======
    let stream = null;
    let currentFacing
= 'user';
    let rotation = 0;
    let currentFrame =
'main';
    // **แก้ไข State**
    let customFramesMap = new Map();
    let customFrameCounter = 0;
    // let customFrameImg
// = null; // ลบตัวแปรนี้
    let currentDataUrl
= null;
 
    //
======= DOM =======
    const video =
document.getElementById('video');
    const placeholder
= document.getElementById('placeholder');
    const startBtn =
document.getElementById('startCamera');
    const switchBtn =
document.getElementById('switchCamera');
    const rotateBtn =
document.getElementById('rotate90');
    const captureBtn =
document.getElementById('capture');
    const timerBtn =
document.getElementById('timerBtn');
    const timerRow =
document.getElementById('timerRow');
    const
cancelTimerBtn = document.getElementById('cancelTimer');
    const countdownEl
= document.getElementById('countdown');
 
    const nickname =
document.getElementById('nickname');
    const team =
document.getElementById('team');
 
    const brightness =
document.getElementById('brightness');
    const contrast =
document.getElementById('contrast');
    const bVal =
document.getElementById('bVal');
    const cVal =
document.getElementById('cVal');
 
    const framesWrap =
document.getElementById('frames');
    const customInput
= document.getElementById('customFrame');
    // const customBtn =
// document.getElementById('customBtn'); // ลบตัวแปรนี้
    const customFramesContainer = document.getElementById('customFramesContainer'); // **เพิ่มตัวแปรนี้**
    const sizeSel =
document.getElementById('size');
 
    const work =
document.getElementById('work');
    const wctx =
work.getContext('2d');
 
    const previewPanel
= document.getElementById('previewPanel');
    const previewImg =
document.getElementById('previewImg');
    const downloadBtn
= document.getElementById('downloadBtn');
    const qrBtn =
document.getElementById('qrBtn');
    const qrSection =
document.getElementById('qrSection');
    const qrCanvas =
document.getElementById('qrCanvas');
 
    //
======= Init UI =======
   brightness.addEventListener('input', () => {
      bVal.textContent
= brightness.value + '%';
      applyFilters();
    });
   contrast.addEventListener('input', () => {
      cVal.textContent
= contrast.value + '%';
      applyFilters();
    });

    // **แก้ไข: ใช้ฟังก์ชันจัดการคลิกเฟรมใหม่**
    function handleFrameClick(e) {
        const el = e.currentTarget;
        // ลบ active จากปุ่มทั้งหมดในทุกคอนเทนเนอร์
        framesWrap.querySelectorAll('.frame-btn').forEach(b => b.classList.remove('active'));
        customFramesContainer.querySelectorAll('.frame-btn').forEach(b => b.classList.remove('active'));

        el.classList.add('active');
        currentFrame = el.dataset.frame;
    }

    // **แก้ไข: ฟังก์ชันสำหรับตั้งค่า Event Listener ให้กับปุ่มเฟรมทั้งหมด**
    function setupFrameButtons(){
        framesWrap.querySelectorAll('.frame-btn').forEach(b => {
            b.removeEventListener('click', handleFrameClick); // ป้องกันการเพิ่มซ้ำ
            b.addEventListener('click', handleFrameClick);
        });
        customFramesContainer.querySelectorAll('.frame-btn').forEach(b => {
            b.removeEventListener('click', handleFrameClick);
            b.addEventListener('click', handleFrameClick);
        });
    }
    setupFrameButtons(); // เรียกใช้ครั้งแรกสำหรับปุ่ม Built-in

    // **แก้ไข: Logic สำหรับการอัปโหลดหลายไฟล์**
    customInput.addEventListener('change', e => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        // ล้าง Map และปุ่มเดิมทั้งหมด
        customFramesMap.clear();
        customFramesContainer.innerHTML = '';
        customFrameCounter = 0;
        let isFirstFrame = true;

        // วนลูปจัดการไฟล์ที่อัปโหลดทั้งหมด
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();
            const frameId = `custom-${++customFrameCounter}`;
            const frameName = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;

            reader.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    customFramesMap.set(frameId, img); // เก็บ Image object ไว้ใน Map

                    // สร้างปุ่มเฟรมแบบ Dynamic
                    const btn = document.createElement('div');
                    btn.className = 'frame-btn';
                    btn.dataset.frame = frameId;
                    btn.textContent = frameName;
                    customFramesContainer.appendChild(btn);

                    // ตั้งค่าเฟรมแรกที่โหลดเสร็จเป็น Active (ถ้าไม่มีเฟรมอื่น Active อยู่)
                    if (isFirstFrame) {
                        framesWrap.querySelectorAll('.frame-btn.active').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentFrame = frameId;
                        isFirstFrame = false;
                    }

                    // ตั้งค่า Event Listener สำหรับปุ่มใหม่ทั้งหมด
                    setupFrameButtons();
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
 
    startBtn.addEventListener('click', startCamera);
    // ... (โค้ด Event Listener ส่วนที่เหลือเหมือนเดิม)
 
    // ... (โค้ด startCamera, applyFilters เหมือนเดิม)
 
    //
======= Capture (มีการเปลี่ยนแปลงใน drawFrame) =======
    function
capture(){
      if
(!validateNames()) return;
 
      const sel =
sizeSel.value;
      let w=1920,h=1080;
      if
(sel==='hd'){w=1280;h=720}
      if (sel==='4k'){w=3840;h=2160}
 
      work.width = w;
work.height = h;
      wctx.save();
 
     // หมุนภาพใน canvas หากมีการหมุน
      if (rotation !==0){
       wctx.translate(w/2, h/2);
       wctx.rotate(rotation * Math.PI / 180);
       wctx.translate(-w/2, -h/2);
      }
 
     // จำลอง filter สำคัญ: ใช้เฉพาะ brightness/contrast
      const b =
brightness.value, c = contrast.value;
      wctx.filter =
`brightness(${b}%) contrast(${c}%)`;
     wctx.drawImage(video, 0, 0, w, h);
      wctx.filter =
'none';
 
     // วาดกรอบ
      drawFrame(wctx,
w, h);
 
     // วาดข้อความ
     drawTextOverlay(wctx, w, h);
 
      wctx.restore();
 
      currentDataUrl =
work.toDataURL('image/png');
      previewImg.src =
currentDataUrl;
     previewPanel.style.display = 'block';
     qrSection.style.display = 'none';
     window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
      flashWhite();
    }
 
    function
drawFrame(ctx, w, h){
      const id =
currentFrame;
      ctx.save();
 
     // กรอบพื้นฐาน
      ctx.strokeStyle
= '#7b3fe4';
      ctx.lineWidth = 10;
      ctx.strokeRect(10,10,w-20,h-20);
 
      if
(id==='champ'){
        const
g=ctx.createLinearGradient(0,0,w,h);
       g.addColorStop(0,'#ffd700'); g.addColorStop(.5,'#b87333');
g.addColorStop(1,'#ffd700');
       ctx.strokeStyle=g; ctx.lineWidth=12; ctx.strokeRect(8,8,w-16,h-16);
      }
      if
(id==='hero'){
        const
rg=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.max(w,h)/2);
       rg.addColorStop(0,'rgba(0,212,255,.25)');
rg.addColorStop(1,'transparent');
       ctx.fillStyle=rg; ctx.fillRect(0,0,w,h);
      }
      if
(id==='glitch'){
       ctx.strokeStyle='#ff0080'; ctx.lineWidth=10;
ctx.strokeRect(10,10,w-20,h-20);
       ctx.strokeStyle='#00ff88'; ctx.lineWidth=2;
        for(let i=0;i<5;i++){
const y=Math.random()*h; ctx.beginPath(); ctx.moveTo(0,y);
ctx.lineTo(w,y); ctx.stroke(); }
      }
      if
(id==='neon'){
       ctx.shadowColor='#00d4ff'; ctx.shadowBlur=18;
ctx.strokeStyle='#00d4ff'; ctx.lineWidth=8;
       ctx.strokeRect(16,16,w-32,h-32);
ctx.shadowBlur=0;
      }
      if
(id==='sponsor'){
       ctx.strokeStyle='rgba(0,212,255,.6)';
ctx.lineWidth=12; ctx.strokeRect(10,10,w-20,h-20);
       ctx.fillStyle='rgba(255,255,255,.1)';
ctx.fillRect(w-220,h-120,200,90);
       ctx.strokeStyle='rgba(0,212,255,.45)';
ctx.lineWidth=2; ctx.strokeRect(w-220,h-120,200,90);
       ctx.fillStyle='rgba(255,255,255,.75)';
ctx.font='bold 18px Arial'; ctx.textAlign='center';
       ctx.fillText('SPONSOR LOGO', w-120, h-70);
      }

      // **แก้ไข: Logic สำหรับ Custom Frame ที่มีหลายรายการ**
      if (id.startsWith('custom-')){
          const customImg = customFramesMap.get(id);
          if(customImg){
              ctx.drawImage(customImg, 0, 0, w, h);
          }
      }
 
     // ชื่อเฟรม
      const titleMap={
        main:'RVC101
Esports Challenge 2025 — v12',
        champ:'👑
Champion Mode',
        hero:'⚡
Team Hero',
        glitch:'🔥
Glitch Style',
        neon:'💎
Cyber Neon',
       sponsor:'Powered by Sponsors',
      };
       // **แก้ไข: การแสดงชื่อ Title สำหรับ Custom Frame**
       const title = titleMap[id] || (id.startsWith('custom-') ? `🖼️ Custom Frame #${id.split('-')[1]}` : titleMap.main);
      
      ctx.fillStyle='#00d4ff';
ctx.font='bold 26px Arial'; ctx.textAlign='center';
      ctx.fillText(title, w/2,56);
 
      ctx.restore();
    }
 
    // ... (โค้ด drawTextOverlay, validateNames เหมือนเดิม)
    // ... (โค้ด Countdown, QR helper, Small UX เหมือนเดิม)
    
  </script>
</body>
</html>
