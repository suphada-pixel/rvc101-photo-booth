<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RVC101 Photo Booth PRO v4</title>
<style>
  :root{
    --bg:#0b0f1a; --card:#12172a; --text:#e8edff; --accent:#6ee7ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,TH Sarabun New,Arial;
    color:var(--text);
    background:radial-gradient(1200px 600px at 70% -10%,#122,transparent), var(--bg);
    display:flex; min-height:100vh; align-items:center; justify-content:center; padding:18px;
  }
  .app{
    width:100%; max-width:820px;
    background:var(--card); border-radius:20px; padding:20px;
    box-shadow:0 10px 40px rgba(0,0,0,.6);
  }
  h1{text-align:center; font-size:22px; margin:0 0 14px;}
  .stage{
    position:relative; border-radius:16px; overflow:hidden;
    background:#000; display:flex; align-items:center; justify-content:center;
    width:100%; height:480px;
  }
  video, canvas, img.preview{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:contain; border-radius:16px;
  }
  #framePreview{z-index:10; opacity:0.95; pointer-events:none;}
  .overlay-tip{
    position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,.6);
    padding:4px 8px; border-radius:8px; font-size:13px; z-index:11;
  }
  #countdown{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    font-size:120px; font-weight:bold; color:#fff;
    text-shadow:0 0 20px #6ee7ff;
    z-index:20; opacity:0; transition:opacity 0.3s;
  }
  #flash{
    position:absolute; inset:0; background:white; opacity:0;
    z-index:30; transition:opacity 0.4s ease-out;
  }
  .controls{display:grid; gap:10px; margin-top:16px;}
  .row{display:flex; gap:8px; flex-wrap:wrap; justify-content:center;}
  button,label.btn{
    border:none; cursor:pointer; padding:12px 16px;
    border-radius:12px; font-weight:600; letter-spacing:.2px;
    color:#001018; background:linear-gradient(180deg,var(--accent),#4ad1f0);
    box-shadow:0 6px 16px rgba(78,221,255,.28);
    transition:transform .06s ease;
  }
  button.ghost,label.btn.ghost{background:#1b2240; color:#d6ddff;}
  button:active,label.btn:active{transform:translateY(1px);}
  input[type=file]{display:none}
  .frame-list{
    display:flex; overflow-x:auto; gap:10px; margin-top:10px; padding:6px 2px;
  }
  .frame-thumb{
    flex:0 0 auto; width:100px; height:60px; border-radius:10px;
    border:2px solid transparent; cursor:pointer; overflow:hidden;
    transition:transform .15s;
  }
  .frame-thumb:hover{transform:scale(1.05);}
  .frame-thumb img{width:100%; height:100%; object-fit:cover;}
  .frame-thumb.active{border-color:#6ee7ff;}
  #previewControls{display:none; text-align:center; margin-top:10px;}
  #previewImage{border-radius:16px; width:100%; max-width:720px;}
  #qrcode canvas{width:160px!important;height:160px!important;}
</style>
</head>
<body>
<div class="app">
  <h1>üì∏ RVC101 E-Sports Challenge 2025 ‚Äì Photo Booth PRO v4</h1>

  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="framePreview"></canvas>
    <div id="countdown">3</div>
    <div id="flash"></div>
    <div class="overlay-tip" id="tip">Align your face, then tap <b>Take Photo</b></div>
  </div>

  <div class="frame-list" id="frameList"></div>

  <div class="controls" id="mainControls">
    <div class="row">
      <label for="frameInput" class="btn ghost">üñºÔ∏è Upload Frames</label>
      <button id="openCam" class="ghost">üé• Open Camera</button>
    </div>
    <div class="row">
      <button id="snap">üì∑ Take Photo</button>
      <button id="retake" class="ghost">‚Ü©Ô∏è Retake</button>
    </div>
  </div>

  <div id="previewControls">
    <img id="previewImage" src="">
    <div class="row" style="justify-content:center;margin-top:8px;">
      <button id="download">‚¨áÔ∏è Download & QR</button>
      <button id="again" class="ghost">üîÅ Take Again</button>
    </div>
    <div id="qrcode" style="text-align:center;margin-top:10px;"></div>
  </div>

  <input id="frameInput" type="file" accept="image/png,image/*" multiple>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script>
const video=document.getElementById('video');
const frameCanvas=document.getElementById('framePreview');
const fctx=frameCanvas.getContext('2d');
const frameInput=document.getElementById('frameInput');
const frameList=document.getElementById('frameList');
const countdown=document.getElementById('countdown');
const flash=document.getElementById('flash');
let frames=[],currentFrameIndex=-1,stream=null,loopRun=false,resultURL="";

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
function openCamera(){
  navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}})
  .then(s=>{stream=s; video.srcObject=s;})
  .catch(e=>alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: "+e));
}
// Loop ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö
function startLoop(){
  if(loopRun) return;
  loopRun=true;
  const loop=()=>{
    if(!loopRun) return;
    frameCanvas.width=video.videoWidth;
    frameCanvas.height=video.videoHeight;
    fctx.clearRect(0,0,frameCanvas.width,frameCanvas.height);
    if(frames[currentFrameIndex]){
      fctx.drawImage(frames[currentFrameIndex],0,0,frameCanvas.width,frameCanvas.height);
    }
    requestAnimationFrame(loop);
  };
  loop();
}
function stopLoop(){loopRun=false;}
function selectFrame(i){
  currentFrameIndex=i;
  document.querySelectorAll('.frame-thumb').forEach((el,idx)=>{
    el.classList.toggle('active',idx===i);
  });
}
frameInput.addEventListener('change',e=>{
  const files=Array.from(e.target.files);
  frames=[]; frameList.innerHTML='';
  files.forEach((file,i)=>{
    const url=URL.createObjectURL(file);
    const img=new Image();
    img.onload=()=>{frames[i]=img; if(currentFrameIndex===-1){currentFrameIndex=0; startLoop();}}
    img.src=url;
    const thumb=document.createElement('div');
    thumb.className='frame-thumb';
    thumb.innerHTML=`<img src="${url}">`;
    thumb.onclick=()=>selectFrame(i);
    frameList.appendChild(thumb);
  });
});
document.getElementById('openCam').onclick=openCamera;

// üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
document.getElementById('snap').onclick=async ()=>{
  if(!frames.length){alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≠‡∏ö");return;}
  await countdownSequence(3); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
  takePhoto();
};

// ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
function countdownSequence(seconds){
  return new Promise(resolve=>{
    let count=seconds;
    countdown.textContent=count;
    countdown.style.opacity=1;
    const interval=setInterval(()=>{
      count--;
      if(count>0){countdown.textContent=count;}
      else{
        clearInterval(interval);
        countdown.style.opacity=0;
        flashEffect();
        setTimeout(()=>resolve(),300);
      }
    },1000);
  });
}

// ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏ü‡∏•‡∏ä
function flashEffect(){
  flash.style.opacity=1;
  setTimeout(()=>flash.style.opacity=0,400);
}

// ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á
function takePhoto(){
  const c=document.createElement('canvas');
  c.width=video.videoWidth; c.height=video.videoHeight;
  const ctx=c.getContext('2d');
  ctx.drawImage(video,0,0);
  if(frames[currentFrameIndex]) ctx.drawImage(frames[currentFrameIndex],0,0,c.width,c.height);
  resultURL=c.toDataURL('image/png');
  stopLoop();
  video.style.display='none';
  frameCanvas.style.display='none';
  document.getElementById('tip').style.display='none';
  document.getElementById('mainControls').style.display='none';
  document.getElementById('previewImage').src=resultURL;
  document.getElementById('previewControls').style.display='block';
}

// ‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û
document.getElementById('download').onclick=()=>{
  const a=document.createElement('a');
  a.href=resultURL; a.download="rvc101-photo.png"; a.click();
  document.getElementById('qrcode').innerHTML='';
  new QRCode(document.getElementById('qrcode'), resultURL);
};

// üîÅ ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
document.getElementById('again').onclick=()=>{
  document.getElementById('previewControls').style.display='none';
  video.style.display='block';
  frameCanvas.style.display='block';
  document.getElementById('mainControls').style.display='block';
  document.getElementById('tip').style.display='block';
  document.getElementById('qrcode').innerHTML='';
  openCamera();
  startLoop();
};
document.getElementById('retake').onclick=()=>{openCamera();startLoop();}
</script>
</body>
</html>
