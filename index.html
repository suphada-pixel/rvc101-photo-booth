<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RVC101 Photo Booth</title>
<style>
  :root{
    --bg:#0b0f1a; --card:#12172a; --muted:#2a3354; --text:#e8edff; --accent:#6ee7ff; --accent2:#ffd166;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,TH Sarabun New,Arial;
    color:var(--text); background:radial-gradient(1200px 600px at 70% -10%,#122,transparent), var(--bg);
    display:flex; min-height:100svh; align-items:center; justify-content:center; padding:18px;
  }
  .app{
    width:100%; max-width:480px; background:linear-gradient(180deg,rgba(255,255,255,.03),transparent 20%) , var(--card);
    border:1px solid #1e2540; border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  h1{font-size:20px; margin:0 0 12px; letter-spacing:.5px; text-align:center}
  .stage{
    position:relative; background:#0b0f1a; border:1px solid var(--muted); border-radius:14px; overflow:hidden;
    aspect-ratio:16/9; display:grid; place-items:center;
  }
  video, canvas{ width:100%; height:100%; object-fit:cover; display:block }
  .overlay-tip{
    position:absolute; inset:auto 8px 8px auto; background:rgba(0,0,0,.5); padding:6px 8px; border-radius:8px; font-size:12px
  }
  .frame-badge{
    position:absolute; inset:8px auto auto 8px; background:rgba(0,0,0,.55); padding:6px 10px; border-radius:999px; font-size:12px
  }
  .controls{ display:grid; gap:10px; margin-top:12px }
  .row{ display:flex; gap:8px }
  button, label.btn{
    appearance:none; border:none; cursor:pointer; width:100%;
    padding:12px 14px; border-radius:12px; font-weight:600; letter-spacing:.2px; color:#001018;
    background:linear-gradient(180deg,var(--accent),#4ad1f0);
    box-shadow:0 6px 16px rgba(78,221,255,.28), inset 0 0 0 1px rgba(255,255,255,.5);
    transition:transform .06s ease, filter .2s ease;
  }
  button.secondary{
    background:linear-gradient(180deg,#cbd5ff,#8ea3ff); color:#07102c;
  }
  button.ghost{
    background:#1b2240; color:#d6ddff; box-shadow:inset 0 0 0 1px #2c3766;
  }
  button:active, label.btn:active{ transform:translateY(1px) }
  input[type=file]{ display:none }
  .tips{ font-size:12px; opacity:.85; margin-top:8px; line-height:1.5 }
  .qr-wrap{ display:grid; place-items:center; margin-top:12px }
  #qrcode canvas{ width:180px !important; height:180px !important }
  .hidden{ display:none !important }
</style>
</head>
<body>
  <div class="app">
    <h1>üì∏ RVC101 E-Sports Challenge 2025 ‚Äì Photo Booth</h1>

    <!-- ‡πÄ‡∏ß‡∏ó‡∏µ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
    <div class="stage" id="stage">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="framePreview" class="hidden"></canvas>
      <div class="frame-badge hidden" id="frameBadge">Frame loaded</div>
      <div class="overlay-tip">Align your face, then tap <b>Take Photo</b></div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
    <div class="controls">
      <div class="row">
        <label class="btn ghost" for="frameInput">üñºÔ∏è Upload Frame</label>
        <button id="openCam" class="ghost">üé• Open Camera</button>
      </div>
      <div class="row">
        <button id="snap" class="secondary">üì∑ Take Photo</button>
        <button id="retake" class="ghost">‚Ü©Ô∏è Retake</button>
      </div>
      <div class="row">
        <button id="download" disabled>‚¨áÔ∏è Download & QR</button>
        <button id="share" class="ghost" disabled>üîó Share</button>
      </div>

      <input id="frameInput" type="file" accept="image/png,image/webp,image/*" />
      <div class="qr-wrap hidden" id="qrWrap">
        <div id="qrcode"></div>
        <div class="tips">Scan to open the image on another device</div>
      </div>

      <div class="tips">
        ‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö <b>PNG ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™</b> ‡∏à‡∏∞‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î<br/>
        ‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>Download & QR</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå/QR<br/>
        ‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° <b>Share</b> ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏°‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
      </div>
    </div>
  </div>

  <!-- QR code library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
  (function(){
    const video = document.getElementById('video');
    const frameCanvas = document.getElementById('framePreview');
    const frameCtx = frameCanvas.getContext('2d');
    const stage = document.getElementById('stage');
    const frameInput = document.getElementById('frameInput');
    const frameBadge = document.getElementById('frameBadge');

    const btnOpen = document.getElementById('openCam');
    const btnSnap = document.getElementById('snap');
    const btnRetake = document.getElementById('retake');
    const btnDownload = document.getElementById('download');
    const btnShare = document.getElementById('share');

    const qrWrap = document.getElementById('qrWrap');
    const qrBox = document.getElementById('qrcode');

    let stream = null;
    let frameImg = null;
    let capturedBlob = null;
    let resultDataURL = null;
    let drawingPreview = false;

    async function openCamera(){
      try{
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' }, audio: false
        });
        video.srcObject = stream;
      }catch(e){
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + e.message);
      }
    }

    function stopCamera(){
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    function updateStageAspect(w, h){
      // ‡∏Ñ‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏≠‡∏ö ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if(!w || !h) return;
      stage.style.aspectRatio = `${w} / ${h}`;
    }

    frameInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      frameImg = new Image();
      frameImg.onload = ()=>{
        frameBadge.classList.remove('hidden');
        frameCanvas.classList.remove('hidden');
        updateStageAspect(frameImg.naturalWidth, frameImg.naturalHeight);
        // ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡∏ö‡∏ö‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        startPreviewLoop();
      };
      frameImg.onerror = ()=> alert('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      frameImg.src = url;
    });

    function startPreviewLoop(){
      if(drawingPreview) return;
      drawingPreview = true;
      const loop = ()=>{
        if(!drawingPreview) return;
        const rect = stage.getBoundingClientRect();
        frameCanvas.width = rect.width;
        frameCanvas.height = rect.height;
        frameCtx.clearRect(0,0,frameCanvas.width, frameCanvas.height);
        if(frameImg){
          frameCtx.drawImage(frameImg, 0, 0, frameCanvas.width, frameCanvas.height);
        }
        requestAnimationFrame(loop);
      };
      loop();
    }

    function stopPreviewLoop(){
      drawingPreview = false;
      frameCanvas.classList.add('hidden');
      frameBadge.classList.add('hidden');
    }

    btnOpen.addEventListener('click', openCamera);

    btnSnap.addEventListener('click', async ()=>{
      if(!video.videoWidth){
        await openCamera();
        if(!video.videoWidth){ alert('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°'); return; }
      }

      // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1280px
      const srcW = frameImg ? frameImg.naturalWidth : video.videoWidth;
      const srcH = frameImg ? frameImg.naturalHeight : video.videoHeight;
      const maxW = 1280;
      const scale = Math.min(1, maxW / srcW);
      const outW = Math.round(srcW * scale);
      const outH = Math.round(srcH * scale);

      const canvas = document.createElement('canvas');
      canvas.width = outW; canvas.height = outH;
      const ctx = canvas.getContext('2d');

      // ‡∏ß‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö (cover)
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡∏≠‡∏õ‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
      const videoAR = video.videoWidth / video.videoHeight;
      const frameAR = outW / outH;

      let sx, sy, sw, sh;
      if(videoAR > frameAR){
        // ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤ -> ‡∏Ñ‡∏£‡∏≠‡∏õ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
        sh = video.videoHeight;
        sw = sh * frameAR;
        sx = (video.videoWidth - sw) / 2;
        sy = 0;
      }else{
        // ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏Ñ‡∏ö‡∏Å‡∏ß‡πà‡∏≤ -> ‡∏Ñ‡∏£‡∏≠‡∏õ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
        sw = video.videoWidth;
        sh = sw / frameAR;
        sx = 0;
        sy = (video.videoHeight - sh) / 2;
      }
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, outW, outH);

      // ‡∏ß‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡∏ö
      if(frameImg){
        ctx.drawImage(frameImg, 0, 0, outW, outH);
      }

      // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô JPEG ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ QR ‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
      resultDataURL = canvas.toDataURL('image/jpeg', 0.9);
      // ‡πÄ‡∏Å‡πá‡∏ö Blob ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Share API
      const res = await (await fetch(resultDataURL)).blob();
      capturedBlob = new Blob([res], { type: 'image/jpeg' });

      // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÅ‡∏ö‡∏ï (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏î Retake)
      stopCamera();
      stopPreviewLoop();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏ß‡∏ó‡∏µ‡πÅ‡∏ó‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
      video.classList.add('hidden');
      const show = document.createElement('img');
      show.id = 'resultImg';
      show.style.width = '100%'; show.style.height = '100%'; show.style.objectFit = 'cover';
      show.src = resultDataURL;
      stage.appendChild(show);

      btnDownload.disabled = false;
      btnShare.disabled = false;
      qrWrap.classList.add('hidden');
      qrBox.innerHTML = '';
    });

    btnRetake.addEventListener('click', ()=>{
      // ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      const prev = document.getElementById('resultImg');
      if(prev) prev.remove();
      video.classList.remove('hidden');
      btnDownload.disabled = true;
      btnShare.disabled = true;
      qrWrap.classList.add('hidden');
      qrBox.innerHTML = '';
      resultDataURL = null;
      capturedBlob = null;
      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      openCamera();
      if(frameImg){ startPreviewLoop(); }
    });

    btnDownload.addEventListener('click', ()=>{
      if(!resultDataURL){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢'); return; }

      // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
      const a = document.createElement('a');
      a.href = resultDataURL;
      a.download = `rvC101-photo-${Date.now()}.jpg`;
      document.body.appendChild(a); a.click(); a.remove();

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏à‡∏≤‡∏Å data URL (‡∏≠‡∏≤‡∏à‡∏¢‡∏≤‡∏ß) ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ß‡πÑ‡∏ü/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
      qrBox.innerHTML = '';
      try{
        new QRCode(qrBox, {
          text: resultDataURL,
          width: 180, height: 180,
          correctLevel: QRCode.CorrectLevel.M
        });
        qrWrap.classList.remove('hidden');
      }catch(e){
        alert('‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
      }
    });

    btnShare.addEventListener('click', async ()=>{
      if(!capturedBlob){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢'); return; }
      const file = new File([capturedBlob], `rvC101-photo-${Date.now()}.jpg`, { type:'image/jpeg' });
      if(navigator.canShare && navigator.canShare({ files:[file] })){
        try{
          await navigator.share({
            files:[file],
            title:'RVC101 Photo Booth', text:'‡πÅ‡∏ä‡∏£‡πå‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å RVC101 Photo Booth'
          });
        }catch(e){ /* ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏ä‡∏£‡πå ‡∏Å‡πá‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ */ }
      }else{
        // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô
        const url = URL.createObjectURL(file);
        window.open(url, '_blank');
        setTimeout(()=> URL.revokeObjectURL(url), 30000);
      }
    });

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)
    openCamera();
  })();
  </script>
</body>
</html>
